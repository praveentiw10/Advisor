<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADVISOR - Elite Trading Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-gradient: radial-gradient(circle at 70% 30%, #1e1b4b 0%, #020617 100%);
            --sidebar-bg: #030712;
            --bg-card: rgba(15, 23, 42, 0.6);
            --accent: #22d3ee;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --green: #4ade80;
            --red: #fb7185;
            --gold: #fbbf24;
            --border-line: rgba(255, 255, 255, 0.1);
            --card-item-bg: rgba(255, 255, 255, 0.05);
            --toggle-bg: #115e6e;
        }

        [data-theme="light"] {
            --bg-gradient: radial-gradient(circle at 70% 30%, #f1f5f9 0%, #e2e8f0 100%);
            --sidebar-bg: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.7);
            --accent: #0891b2;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-line: rgba(0, 0, 0, 0.1);
            --card-item-bg: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            transition: background 0.3s, color 0.3s;
        }

        body {
            display: flex;
            height: 100vh;
            background: var(--bg-gradient);
            color: var(--text-main);
            overflow: hidden;
        }

        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-line);
            padding: 0 25px;
            align-items: center;
            justify-content: space-between;
            z-index: 2500;
        }

        .mobile-nav-toggle {
            background: transparent;
            color: var(--accent);
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            padding: 30px 20px;
            border-right: 1px solid var(--border-line);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            height: 100vh;
            overflow-y: auto;
            position: relative;
            flex-shrink: 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 30px;
            color: var(--accent);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-section {
            text-align: center;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-line);
            margin-bottom: 20px;
        }

        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            padding: 3px;
            object-fit: cover;
        }

        .nav {
            list-style: none;
        }

        .nav-label {
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            margin: 20px 0 8px 10px;
            letter-spacing: 1px;
        }

        .nav li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 4px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 14px;
        }

        .nav li:hover,
        .nav li.active {
            background: rgba(34, 211, 238, 0.1);
            color: var(--accent);
        }

        .nav li.active {
            font-weight: bold;
            border-left: 3px solid var(--accent);
            border-radius: 0 10px 10px 0;
        }

        .main {
            flex: 1;
            padding: 30px 40px;
            overflow-y: auto;
            height: 100vh;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .server-status {
            background: rgba(74, 222, 128, 0.1);
            color: var(--green);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .card-box {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 18px;
            border: 1px solid var(--border-line);
            backdrop-filter: blur(15px);
            margin-bottom: 25px;
        }

        .live-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-val {
            font-size: 24px;
            font-weight: bold;
            margin: 8px 0;
        }

        .market-indices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .index-card {
            background: var(--card-item-bg);
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-line);
            transition: all 0.2s ease;
        }

        .index-card:hover {
            background: rgba(34, 211, 238, 0.08);
            border-color: rgba(34, 211, 238, 0.3);
            transform: translateY(-2px);
        }

        .index-name {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .index-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .index-change {
            font-size: 13px;
            font-weight: 600;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .watchlist-card {
            background: var(--bg-card);
            border: 1px solid var(--border-line);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .watchlist-card:hover {
            background: rgba(34, 211, 238, 0.1);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.15);
        }

        .watchlist-symbol {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .watchlist-symbol-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
        }

        .watchlist-exchange {
            font-size: 10px;
            color: var(--text-muted);
            background: var(--card-item-bg);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .watchlist-price {
            font-size: 22px;
            font-weight: 700;
            margin: 6px 0;
            letter-spacing: -0.5px;
        }

        .watchlist-change {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pulse-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .market-summary {
            background: var(--bg-card);
            border: 1px solid var(--border-line);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-line);
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .summary-value {
            font-size: 14px;
            font-weight: 600;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-line);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .chart-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-line);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
        }

        .chart-info {
            font-size: 11px;
            color: var(--text-muted);
        }


        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .mobile-header {
                display: flex;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                width: 280px;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .main {
                padding: 90px 15px 20px 15px;
            }
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1900;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .welcome-banner {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.15) 0%, rgba(34, 211, 238, 0.05) 100%);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 16px 20px;
        }

        .welcome-banner-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .welcome-banner-icon {
            font-size: 1.75rem;
            color: var(--accent);
        }

        .welcome-banner-content strong {
            display: block;
            color: var(--text-main);
            font-size: 15px;
        }

        .welcome-banner-close {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: color 0.2s, background 0.2s;
        }

        .welcome-banner-close:hover {
            color: var(--text-main);
            background: var(--card-item-bg);
        }
    </style>
</head>

<body data-theme="dark" {{#if userName}}data-user-name="{{userName}}" {{/if}}>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <header class="mobile-header">
        <div class="logo" style="margin-bottom:0;"><i class="fa-solid fa-bolt-lightning"></i> ADVISOR</div>
        <button class="mobile-nav-toggle" id="menuBtn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </button>
    </header>

    <aside class="sidebar" id="sidebar">
        <div class="logo"><i class="fa-solid fa-bolt-lightning"></i> ADVISOR</div>

        <div class="profile-section">
            <img src="https://i.pravatar.cc/150?u=b" class="profile-img" alt="Profile">
            <h4 id="user-name-sidebar" style="margin-top: 10px;">Loading...</h4>
            <p style="color:var(--gold); font-weight: bold; font-size: 12px;"><i class="fa-solid fa-crown"></i> Elite
                Account</p>
        </div>

        <p class="nav-label">Terminal</p>
        <ul class="nav">
            <li class="active" onclick="showPage('overview', this)"><i class="fa-solid fa-grip"></i> Overview</li>
            <li onclick="showPage('market', this)"><i class="fa-solid fa-chart-line"></i> Market Terminal</li>
            <li onclick="showPage('portfolios', this)"><i class="fa-solid fa-briefcase"></i> Portfolios</li>
        </ul>

        <p class="nav-label">Reports</p>
        <ul class="nav">
            <li onclick="showPage('history', this)"><i class="fa-solid fa-clock-rotate-left"></i> History Log</li>
            <li onclick="showPage('tax', this)"><i class="fa-solid fa-file-invoice-dollar"></i> Tax Reports</li>
        </ul>

        <p class="nav-label">Account</p>
        <ul class="nav">
            <li onclick="showPage('settings', this)"><i class="fa-solid fa-gear"></i> Settings</li>
        </ul>

        <div style="margin-top: auto; padding-top: 20px;">
            <button class="theme-switch-btn"
                style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border-line); background:var(--card-item-bg); color:var(--text-main); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;"
                onclick="toggleTheme()">
                <i id="theme-icon" class="fa-solid fa-moon"></i>
                <span id="theme-text">Dark Mode</span>
            </button>
            <a href="/" class="logout-box"
                style="background:rgba(251,113,133,0.1); border:1px solid var(--red); color:var(--red); padding:12px; border-radius:12px; text-align:center; text-decoration:none; font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px;"
                onclick="logout()">
                <i class="fa-solid fa-power-off"></i> LOGOUT
            </a>
        </div>
    </aside>

    <main class="main">
        <div id="welcome-banner" class="welcome-banner" style="display: none;">
            <div class="welcome-banner-content">
                <span class="welcome-banner-icon"><i class="fa-solid fa-hand-wave"></i></span>
                <div>
                    <strong id="welcome-banner-title">Welcome to Advisor!</strong>
                    <p id="welcome-banner-text" style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted);">
                        Your account is ready. Start exploring the terminal.</p>
                </div>
                <button type="button" class="welcome-banner-close" onclick="dismissWelcomeBanner()"
                    aria-label="Dismiss"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>
        <div class="header-container">
            <div>
                <h2 id="page-title" style="font-size: 1.5rem;">Portfolio Analytics</h2>
                <p style="color:var(--text-muted); font-size:13px;">Welcome, <span id="user-name-welcome">User</span>.
                    <span id="market-status-text">Markets <span id="market-status"
                            style="color:var(--accent); font-weight:bold;">—</span></span>
                    <span id="last-updated-header" style="color:var(--text-muted); font-size:12px;"> • Updated: —</span>
                </p>
            </div>
            <div class="server-status" id="server-status">● LIVE STATUS: CONNECTING...</div>
        </div>

        <div id="overview-page" class="page-content active">
            <div class="market-indices">
                <div class="index-card">
                    <div class="index-name">S&amp;P 500</div>
                    <div class="index-value" id="index-sp500">—</div>
                    <div class="index-change" id="change-sp500" style="color: var(--text-muted);">—</div>
                </div>
                <div class="index-card">
                    <div class="index-name">NASDAQ</div>
                    <div class="index-value" id="index-nasdaq">—</div>
                    <div class="index-change" id="change-nasdaq" style="color: var(--text-muted);">—</div>
                </div>
                <div class="index-card">
                    <div class="index-name">DOW JONES</div>
                    <div class="index-value" id="index-dow">—</div>
                    <div class="index-change" id="change-dow" style="color: var(--text-muted);">—</div>
                </div>
            </div>

            <div class="market-summary">
                <h3 style="font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-chart-line" style="color: var(--accent);"></i> Market Overview
                </h3>
                <div class="summary-row">
                    <span class="summary-label">Market Status</span>
                    <span class="summary-value" id="summary-market-status" style="color: var(--accent);">—</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Last Update</span>
                    <span class="summary-value" id="summary-last-update">—</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Data Provider</span>
                    <span class="summary-value">Finnhub • TradingView</span>
                </div>
            </div>

            <h3 style="font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-star" style="color: var(--gold);"></i> Watchlist
                <span style="font-size: 11px; color: var(--text-muted); font-weight: normal; margin-left: 8px;">Live
                    prices • Updates every 20s</span>
            </h3>
            <div class="watchlist-grid">
                <div class="watchlist-card" onclick="changeChart('AAPL')">
                    <div class="watchlist-symbol">
                        <span class="watchlist-symbol-name">AAPL</span>
                        <span class="watchlist-exchange">NASDAQ</span>
                    </div>
                    <div class="watchlist-price" id="price-AAPL">$---</div>
                    <div class="watchlist-change" id="change-AAPL">
                        <span class="pulse-dot"></span>
                        <span>--%</span>
                    </div>
                </div>
                <div class="watchlist-card" onclick="changeChart('TSLA')">
                    <div class="watchlist-symbol">
                        <span class="watchlist-symbol-name">TSLA</span>
                        <span class="watchlist-exchange">NASDAQ</span>
                    </div>
                    <div class="watchlist-price" id="price-TSLA">$---</div>
                    <div class="watchlist-change" id="change-TSLA">
                        <span class="pulse-dot"></span>
                        <span>--%</span>
                    </div>
                </div>
                <div class="watchlist-card" onclick="changeChart('NVDA')">
                    <div class="watchlist-symbol">
                        <span class="watchlist-symbol-name">NVDA</span>
                        <span class="watchlist-exchange">NASDAQ</span>
                    </div>
                    <div class="watchlist-price" id="price-NVDA">$---</div>
                    <div class="watchlist-change" id="change-NVDA">
                        <span class="pulse-dot"></span>
                        <span>--%</span>
                    </div>
                </div>
                <div class="watchlist-card" onclick="changeChart('MSFT')">
                    <div class="watchlist-symbol">
                        <span class="watchlist-symbol-name">MSFT</span>
                        <span class="watchlist-exchange">NASDAQ</span>
                    </div>
                    <div class="watchlist-price" id="price-MSFT">$---</div>
                    <div class="watchlist-change" id="change-MSFT">
                        <span class="pulse-dot"></span>
                        <span>--%</span>
                    </div>
                </div>
                <div class="watchlist-card" onclick="changeChart('GOOGL')">
                    <div class="watchlist-symbol">
                        <span class="watchlist-symbol-name">GOOGL</span>
                        <span class="watchlist-exchange">NASDAQ</span>
                    </div>
                    <div class="watchlist-price" id="price-GOOGL">$---</div>
                    <div class="watchlist-change" id="change-GOOGL">
                        <span class="pulse-dot"></span>
                        <span>--%</span>
                    </div>
                </div>
                <div class="watchlist-card" onclick="changeChart('BTC')">
                    <div class="watchlist-symbol">
                        <span class="watchlist-symbol-name">BTC</span>
                        <span class="watchlist-exchange">CRYPTO</span>
                    </div>
                    <div class="watchlist-price" id="price-BTC">$---</div>
                    <div class="watchlist-change" id="change-BTC">
                        <span class="pulse-dot"></span>
                        <span>--%</span>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title" id="chart-title-overview">AAPL - Apple Inc.</div>
                        <div class="chart-info">Interactive chart • Click watchlist to change symbol</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span class="pulse-dot"></span>
                        <span style="font-size: 11px; color: var(--green);">LIVE</span>
                    </div>
                </div>
                <div id="tradingview_chart_overview" style="height:500px; width:100%;"></div>
            </div>
        </div>

        <div id="market-page" class="page-content">
            <div class="market-summary" style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-chart-candlestick" style="color: var(--accent);"></i> Market Terminal
                </h3>
                <div class="summary-row">
                    <span class="summary-label">Current Symbol</span>
                    <span class="summary-value" id="terminal-symbol">TSLA</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Exchange</span>
                    <span class="summary-value" id="terminal-exchange">NASDAQ</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Data Source</span>
                    <span class="summary-value">TradingView • Real-time</span>
                </div>
            </div>

            <div class="chart-container" style="min-height: 650px;">
                <div class="chart-header">
                    <div>
                        <div class="chart-title" id="chart-title-terminal">TSLA - Tesla Inc.</div>
                        <div class="chart-info">Full-featured chart • Change symbol/timeframe in widget • All timeframes
                            available</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span class="pulse-dot"></span>
                        <span style="font-size: 11px; color: var(--green);">STREAMING</span>
                    </div>
                </div>
                <div id="tradingview_chart_full" style="height:650px; width:100%;"></div>
            </div>
        </div>

        <div id="portfolios-page" class="page-content">
            <div class="card-box" style="margin-bottom: 25px;">
                <h3>Portfolio Summary</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 20px;">Connect your broker or link a
                    trading account to see your real portfolio value and positions here.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                    <div style="background:var(--card-item-bg); padding: 18px; border-radius: 10px;">
                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Total Value</p>
                        <p style="font-size: 20px; font-weight: 700;">—</p>
                    </div>
                    <div style="background:var(--card-item-bg); padding: 18px; border-radius: 10px;">
                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Cash Balance</p>
                        <p style="font-size: 20px; font-weight: 700;">—</p>
                    </div>
                    <div style="background:var(--card-item-bg); padding: 18px; border-radius: 10px;">
                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Invested</p>
                        <p style="font-size: 20px; font-weight: 700;">—</p>
                    </div>
                    <div style="background:var(--card-item-bg); padding: 18px; border-radius: 10px;">
                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">P&amp;L (Unrealized)
                        </p>
                        <p style="font-size: 20px; font-weight: 700;">—</p>
                    </div>
                </div>
            </div>

            <div class="card-box" style="margin-bottom: 25px;">
                <h3>Holdings</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 15px;">Your positions will appear
                    here when you connect a broker or have trading activity.</p>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr
                                style="border-bottom: 1px solid var(--border-line); color: var(--text-muted); font-size: 11px; text-transform: uppercase;">
                                <th style="padding: 10px; text-align: left;">Symbol</th>
                                <th style="padding: 10px; text-align: right;">Qty</th>
                                <th style="padding: 10px; text-align: right;">Avg Cost</th>
                                <th style="padding: 10px; text-align: right;">LTP</th>
                                <th style="padding: 10px; text-align: right;">Value</th>
                                <th style="padding: 10px; text-align: right;">P&amp;L</th>
                            </tr>
                        </thead>
                        <tbody id="holdings-tbody">
                            <tr>
                                <td colspan="6"
                                    style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                                    No positions. Connect your broker or place trades to see real holdings.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-box">
                <h3>Asset Allocation</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 20px;">Breakdown by segment will
                    appear when you have holdings.</p>
                <div
                    style="padding: 30px; text-align: center; color: var(--text-muted); background: var(--card-item-bg); border-radius: 10px;">
                    No allocation data yet. Real data from your connected account.
                </div>
            </div>
        </div>

        <div id="history-page" class="page-content">
            <div class="card-box">
                <h3>Order History</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 15px;">Real order log from your
                    connected broker. Settlement: T+2 equity, T+0 crypto.</p>
                <div style="overflow-x: auto;">
                    <table class="history-table"
                        style="width: 100%; border-collapse: collapse; margin-top: 10px; color: var(--text-main); font-size: 13px;">
                        <thead>
                            <tr
                                style="border-bottom: 1px solid var(--border-line); text-align: left; color: var(--text-muted); font-size: 11px; text-transform: uppercase;">
                                <th style="padding: 10px;">Order ID</th>
                                <th style="padding: 10px;">Date &amp; Time</th>
                                <th style="padding: 10px;">Symbol</th>
                                <th style="padding: 10px;">Side</th>
                                <th style="padding: 10px;">Qty</th>
                                <th style="padding: 10px;">Price</th>
                                <th style="padding: 10px;">Amount</th>
                                <th style="padding: 10px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8"
                                    style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                                    No orders yet. Your trade history will appear here when you place orders through a
                                    connected account.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 12px; font-size: 11px; color: var(--text-muted);">Report generated: <span
                        id="history-report-generated">—</span>. Real data from broker when connected.</p>
            </div>
        </div>

        <div id="tax-page" class="page-content">
            <div id="tax-report-content" class="card-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3>Tax Summary</h3>
                        <p style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">Generated: <span
                                id="tax-generated-date">—</span>. Real data when you have realized gains from connected
                            broker.</p>
                    </div>
                    <button id="tax-export-pdf-btn" type="button"
                        style="background:var(--accent); border:none; color:#000; padding:8px 15px; border-radius:8px; font-weight:700; cursor:pointer;">
                        <i class="fa-solid fa-download"></i> Export PDF
                    </button>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 14px; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-line); color: var(--text-muted);">
                            <th style="padding: 12px;">Asset Class</th>
                            <th style="padding: 12px;">Turnover</th>
                            <th style="padding: 12px;">Realized P&amp;L</th>
                            <th style="padding: 12px;">Tax Rate</th>
                            <th style="padding: 12px;">Tax Liability</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid var(--border-line);">
                            <td style="padding: 15px;">Equity (LTCG)</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">10%</td>
                            <td style="padding: 15px;">$0</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-line);">
                            <td style="padding: 15px;">Equity (STCG)</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">15%</td>
                            <td style="padding: 15px;">$0</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-line);">
                            <td style="padding: 15px;">Intraday / F&amp;O</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">—</td>
                            <td style="padding: 15px;">$0</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border-line);">
                            <td style="padding: 15px;">Crypto / VDA</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">30%</td>
                            <td style="padding: 15px;">$0</td>
                        </tr>
                        <tr style="border-top: 2px solid var(--border-line); font-weight: 700;">
                            <td style="padding: 15px;">Total</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">$0</td>
                            <td style="padding: 15px;">—</td>
                            <td style="padding: 15px;">$0</td>
                        </tr>
                    </tbody>
                </table>

                <div
                    style="margin-top: 25px; padding: 20px; background: var(--card-item-bg); border-radius: 12px; border: 1px dashed var(--border-line);">
                    <p style="font-size: 13px; color: var(--text-muted);">
                        <i class="fa-solid fa-circle-info"></i> No realized gains in this period. Connect your broker
                        and trade to see real tax figures. This report is for record-keeping; consult a tax professional
                        for advice.
                    </p>
                </div>
            </div>
        </div>

        <div id="settings-page" class="page-content">
            <div class="card-box" style="margin-bottom: 25px;">
                <h3>Market Data</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 20px;">Live quotes and charts on this
                    dashboard.</p>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr style="border-bottom: 1px solid var(--border-line);">
                        <td style="padding: 12px; color: var(--text-muted); width: 200px;">Quote API</td>
                        <td style="padding: 12px;">Finnhub (real-time)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-line);">
                        <td style="padding: 12px; color: var(--text-muted);">Charts</td>
                        <td style="padding: 12px;">TradingView</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-line);">
                        <td style="padding: 12px; color: var(--text-muted);">Last price update</td>
                        <td style="padding: 12px;" id="settings-last-sync">—</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; color: var(--text-muted);">Currency</td>
                        <td style="padding: 12px;"><span style="color:var(--accent); font-weight: 600;">USD</span></td>
                    </tr>
                </table>
            </div>

            <div class="card-box" style="margin-bottom: 25px;">
                <h3>Preferences</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 20px;">Display settings.</p>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr style="border-bottom: 1px solid var(--border-line);">
                        <td style="padding: 12px; color: var(--text-muted); width: 200px;">Theme</td>
                        <td style="padding: 12px;">Dark / Light (toggle in sidebar)</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; color: var(--text-muted);">Language</td>
                        <td style="padding: 12px;">English</td>
                    </tr>
                </table>
            </div>

            <div class="card-box">
                <h3>Session</h3>
                <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 20px;">This browser session.</p>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <tr style="border-bottom: 1px solid var(--border-line);">
                        <td style="padding: 12px; color: var(--text-muted); width: 200px;">Session started</td>
                        <td style="padding: 12px;" id="settings-session-started">—</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; color: var(--text-muted);">Broker connection</td>
                        <td style="padding: 12px;">Not connected — connect to see portfolio, orders &amp; tax data</td>
                    </tr>
                </table>
            </div>
        </div>

    </main>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>

        const symbols = ['AAPL', 'TSLA', 'NVDA', 'MSFT', 'GOOGL', 'BTC'];
        const indices = ['SPY', 'QQQ', 'DIA'];
        let chartWidgetOverview = null;
        let chartWidgetTerminal = null;

        function getMarketStatus() {
            var now = new Date();
            var et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            var day = et.getDay();
            var h = et.getHours();
            var m = et.getMinutes();
            var mins = h * 60 + m;
            if (day === 0 || day === 6) return { text: 'Closed', live: false };
            if (mins < 4 * 60 + 0) return { text: 'Pre-Market', live: true };
            if (mins < 9 * 60 + 30) return { text: 'Pre-Market', live: true };
            if (mins < 16 * 60 + 0) return { text: 'Open', live: true };
            if (mins < 20 * 60 + 0) return { text: 'After-Hours', live: true };
            return { text: 'Closed', live: false };
        }

        function updateMarketStatus() {
            var st = getMarketStatus();
            var el = document.getElementById('market-status');
            if (el) el.textContent = st.text;
            var summaryEl = document.getElementById('summary-market-status');
            if (summaryEl) summaryEl.textContent = st.text;
        }

        function updateLastUpdated() {
            var t = new Date();
            var s = t.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            var h = document.getElementById('last-updated-header');
            if (h) h.textContent = ' • Updated: ' + s;
        }

        function setDynamicDates() {
            var d = new Date();
            var dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            var timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            var taxEl = document.getElementById('tax-generated-date');
            if (taxEl) taxEl.textContent = dateStr;
            var syncEl = document.getElementById('settings-last-sync');
            if (syncEl) syncEl.textContent = dateStr + ', ' + timeStr;
            var sessionEl = document.getElementById('settings-session-started');
            if (sessionEl) sessionEl.textContent = dateStr + ', ' + timeStr;
            var histEl = document.getElementById('history-report-generated');
            if (histEl) histEl.textContent = dateStr;
        }

        // Load user info and show welcome message when coming from signup
        (function () {
            const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const serverName = (document.body.getAttribute('data-user-name') || '').trim();
            const userName = user.name || serverName;
            if (userName) {
                document.getElementById('user-name-sidebar').innerText = userName;
                document.getElementById('user-name-welcome').innerText = userName;
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('welcome') === '1') {
                    const banner = document.getElementById('welcome-banner');
                    const titleEl = document.getElementById('welcome-banner-title');
                    const textEl = document.getElementById('welcome-banner-text');
                    if (banner && titleEl) {
                        titleEl.textContent = 'Welcome, ' + userName + '!';
                        if (textEl) textEl.textContent = 'Your account is ready. Start exploring the terminal.';
                        banner.style.display = 'block';
                    }
                    if (window.history.replaceState) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            } else {
                window.location.href = '/login';
            }
        })();

        function dismissWelcomeBanner() {
            const banner = document.getElementById('welcome-banner');
            if (banner) banner.style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
        }


        function showPage(pageId, element) {

            document.querySelectorAll('.nav li').forEach(li => li.classList.remove('active'));
            element.classList.add('active');


            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');


            const titles = { 'overview': 'Portfolio Analytics', 'market': 'Live Market Terminal', 'portfolios': 'Active Holdings', 'history': 'Trade History', 'tax': 'Tax Center', 'settings': 'System Settings' };
            document.getElementById('page-title').innerText = titles[pageId];


            if (window.innerWidth <= 768) toggleSidebar();
        }


        async function fetchRealPrices() {
            const statusEl = document.getElementById('server-status');
            const summaryUpdate = document.getElementById('summary-last-update');

            // Fetch indices
            for (const idx of indices) {
                try {
                    const response = await fetch(`/api/stock/${idx}`);
                    const data = await response.json();
                    if (data.c != null) {
                        const idxName = idx === 'SPY' ? 'sp500' : idx === 'QQQ' ? 'nasdaq' : 'dow';
                        const idxEl = document.getElementById(`index-${idxName}`);
                        const changeEl = document.getElementById(`change-${idxName}`);
                        if (idxEl) idxEl.innerText = data.c.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        if (changeEl) {
                            const change = data.dp != null ? data.dp : 0;
                            changeEl.innerText = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                            changeEl.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
                        }
                    }
                } catch (e) { }
            }

            // Fetch watchlist symbols
            for (const sym of symbols) {
                try {
                    const fetchSym = sym === 'BTC' ? 'BINANCE:BTCUSDT' : sym;
                    const response = await fetch(`/api/stock/${fetchSym}`);
                    const data = await response.json();
                    if (data.c != null) {
                        const priceEl = document.getElementById(`price-${sym}`);
                        if (priceEl) {
                            priceEl.innerText = `$${data.c.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        }
                        const change = data.dp != null ? data.dp : 0;
                        const changeEl = document.getElementById(`change-${sym}`);
                        if (changeEl) {
                            const changeText = changeEl.querySelector('span:last-child');
                            if (changeText) {
                                changeText.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                            } else {
                                changeEl.innerHTML = `<span class="pulse-dot"></span><span>${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`;
                            }
                            changeEl.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
                        }
                        statusEl.innerText = " ● LIVE STATUS : CONNECTED ";
                        statusEl.style.color = "var(--green)";
                    }
                } catch (e) {
                    if (sym === symbols[0]) {
                        statusEl.innerText = "● LIVE STATUS: API ERROR";
                        statusEl.style.color = "var(--red)";
                    }
                }
            }

            if (summaryUpdate) {
                const now = new Date();
                summaryUpdate.textContent = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
            updateLastUpdated();
            updateMarketStatus();
        }

        const symbolNames = {
            'AAPL': 'Apple Inc.',
            'TSLA': 'Tesla Inc.',
            'NVDA': 'NVIDIA Corporation',
            'MSFT': 'Microsoft Corporation',
            'GOOGL': 'Alphabet Inc.',
            'AMZN': 'Amazon.com Inc.',
            'META': 'Meta Platforms Inc.',
            'BTC': 'Bitcoin',
            'ETH': 'Ethereum'
        };

        function extractSymbol(fullSymbol) {
            if (!fullSymbol) return null;
            const parts = fullSymbol.split(':');
            if (parts.length > 1) {
                const sym = parts[1].replace('USDT', '').replace('USD', '');
                return sym;
            }
            return fullSymbol.replace('NASDAQ:', '').replace('NYSE:', '').replace('BINANCE:', '').replace('USDT', '').replace('USD', '');
        }

        function getExchange(fullSymbol) {
            if (!fullSymbol) return 'NASDAQ';
            if (fullSymbol.includes('BINANCE') || fullSymbol.includes('CRYPTO')) return 'CRYPTO';
            if (fullSymbol.includes('NYSE')) return 'NYSE';
            return 'NASDAQ';
        }

        function updateTerminalUI(symbol, fullSymbol) {
            const cleanSymbol = extractSymbol(fullSymbol || symbol);
            const exchange = getExchange(fullSymbol || symbol);
            const companyName = symbolNames[cleanSymbol] || cleanSymbol;

            const terminalSymbolEl = document.getElementById('terminal-symbol');
            const chartTitleEl = document.getElementById('chart-title-terminal');
            const terminalExchangeEl = document.getElementById('terminal-exchange');

            if (terminalSymbolEl && cleanSymbol) terminalSymbolEl.textContent = cleanSymbol;
            if (chartTitleEl && cleanSymbol) chartTitleEl.textContent = `${cleanSymbol} - ${companyName}`;
            if (terminalExchangeEl) terminalExchangeEl.textContent = exchange;
        }

        function changeChart(symbol) {
            if (!chartWidgetOverview) return;
            const exchange = symbol === 'BTC' ? 'BINANCE' : 'NASDAQ';
            const fullSymbol = symbol === 'BTC' ? 'BINANCE:BTCUSDT' : `${exchange}:${symbol}`;
            chartWidgetOverview.setSymbol(fullSymbol, 'D');
            const titleEl = document.getElementById('chart-title-overview');
            if (titleEl) titleEl.textContent = `${symbol} - ${symbolNames[symbol] || symbol}`;
        }


        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('theme-icon').classList.replace(isDark ? 'fa-moon' : 'fa-sun', isDark ? 'fa-sun' : 'fa-moon');
            document.getElementById('theme-text').innerText = isDark ? 'Light Mode' : 'Dark Mode';
        }


        chartWidgetOverview = new TradingView.widget({
            "autosize": true,
            "symbol": "NASDAQ:AAPL",
            "interval": "D",
            "theme": "dark",
            "container_id": "tradingview_chart_overview",
            "allow_symbol_change": true,
            "toolbar_bg": "#030712",
            "hide_side_toolbar": false,
            "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"]
        });

        chartWidgetTerminal = new TradingView.widget({
            "autosize": true,
            "symbol": "NASDAQ:TSLA",
            "interval": "D",
            "theme": "dark",
            "container_id": "tradingview_chart_full",
            "allow_symbol_change": true,
            "toolbar_bg": "#030712",
            "hide_side_toolbar": false,
            "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies", "Volume@tv-basicstudies"],
            "callback": function (widget) {
                widget.onChartReady(function () {
                    widget.subscribe('onSymbolChanged', function (symbol, interval) {
                        updateTerminalUI(null, symbol);
                    });
                    updateTerminalUI('TSLA', 'NASDAQ:TSLA');
                });
            }
        });

        function setupTerminalSymbolTracking() {
            let lastSymbol = 'TSLA';
            const checkSymbol = function () {
                try {
                    if (window.tvWidget && window.tvWidget.activeChart) {
                        const chart = window.tvWidget.activeChart();
                        if (chart && chart.symbol) {
                            const currentSymbol = chart.symbol();
                            if (currentSymbol && currentSymbol !== lastSymbol) {
                                lastSymbol = extractSymbol(currentSymbol) || currentSymbol;
                                updateTerminalUI(lastSymbol, currentSymbol);
                            }
                        }
                    }
                } catch (e) { }
            };
            setInterval(checkSymbol, 1500);
        }

        setTimeout(function () {
            const chartContainer = document.getElementById('tradingview_chart_full');
            if (chartContainer) {
                let lastDetectedSymbol = 'TSLA';
                const checkForSymbolChange = function () {
                    try {
                        const iframe = chartContainer.querySelector('iframe');
                        if (iframe && iframe.contentWindow) {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc) {
                                const bodyText = iframeDoc.body ? iframeDoc.body.innerText || iframeDoc.body.textContent : '';
                                const symbolMatch = bodyText.match(/\b(MSFT|AAPL|TSLA|NVDA|GOOGL|AMZN|META|BTC|ETH)\b/i);
                                if (symbolMatch) {
                                    const detectedSym = symbolMatch[1].toUpperCase();
                                    if (detectedSym !== lastDetectedSymbol) {
                                        lastDetectedSymbol = detectedSym;
                                        updateTerminalUI(detectedSym, detectedSym);
                                    }
                                }
                            }
                        }
                    } catch (e) { }
                };
                setInterval(checkForSymbolChange, 2000);
                setupTerminalSymbolTracking();
            }
        }, 4000);

        updateMarketStatus();
        setDynamicDates();
        setInterval(updateMarketStatus, 60000);
        setInterval(fetchRealPrices, 20000);
        fetchRealPrices();

        function exportTaxReportPdf() {
            var btn = document.getElementById('tax-export-pdf-btn');
            if (!btn) return;
            var el = document.getElementById('tax-report-content');
            if (!el || typeof html2pdf === 'undefined') {
                if (btn) btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> PDF library loading...';
                return;
            }
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
            var opt = {
                margin: 12,
                filename: 'Tax_Summary_Advisor.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(el).save().then(function () {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-download"></i> Export PDF';
            }).catch(function () {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-download"></i> Export PDF';
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            var taxBtn = document.getElementById('tax-export-pdf-btn');
            if (taxBtn) taxBtn.addEventListener('click', exportTaxReportPdf);
        });
    </script>
</body>

</html>